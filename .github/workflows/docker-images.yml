name: Docker Images CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'docker/**'
      - '.github/workflows/docker-images.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'docker/**'
      - '.github/workflows/docker-images.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      build_base:
        description: 'Build base image'
        required: false
        default: 'true'
      build_mvp:
        description: 'Build MVP image (Node.js + Python + Go)'
        required: false
        default: 'true'

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

concurrency:
  group: docker-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Determine what to build
  setup:
    runs-on: ubuntu-latest
    outputs:
      build_base: ${{ steps.check.outputs.build_base }}
      build_mvp: ${{ steps.check.outputs.build_mvp }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine what to build
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "build_base=${{ github.event.inputs.build_base }}" >> "$GITHUB_OUTPUT"
            echo "build_mvp=${{ github.event.inputs.build_mvp }}" >> "$GITHUB_OUTPUT"
          else
            # Check which files changed
            if git diff --name-only HEAD^ HEAD | grep -q '^docker/base/'; then
              echo "build_base=true" >> "$GITHUB_OUTPUT"
              # If base changes, rebuild MVP image
              echo "build_mvp=true" >> "$GITHUB_OUTPUT"
            else
              echo "build_base=false" >> "$GITHUB_OUTPUT"
              if git diff --name-only HEAD^ HEAD | grep -q '^docker/mvp/'; then
                echo "build_mvp=true" >> "$GITHUB_OUTPUT"
              else
                echo "build_mvp=false" >> "$GITHUB_OUTPUT"
              fi
            fi
          fi

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

  # Build and test base image
  build-base:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.build_base == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker

      - name: Build base image
        run: |
          docker build \
            -t dev8-base:${{ needs.setup.outputs.version }} \
            -t dev8-base:latest \
            -f ./docker/base/Dockerfile \
            .

      - name: Test base image
        run: |
          # Test with test token (entrypoint handles this gracefully)
          docker run --rm -e GITHUB_TOKEN=test_token dev8-base:latest sh -c "echo 'Testing base image...' && gh --version && echo 'Base image works!'"
          # Verify key tools are installed
          docker run --rm dev8-base:latest which gh
          docker run --rm dev8-base:latest which git
          docker run --rm dev8-base:latest which ssh

      - name: Scan for vulnerabilities
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: dev8-base:${{ needs.setup.outputs.version }}
          format: 'sarif'
          output: 'trivy-base-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-base-results.sarif') != ''
        with:
          sarif_file: 'trivy-base-results.sarif'
          category: docker-base

      # - name: Export image
      #   run: |
      #     docker save dev8-base:${{ needs.setup.outputs.version }} | gzip > dev8-base.tar.gz

      # - name: Upload base image artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: dev8-base-image
      #     path: dev8-base.tar.gz
      #     retention-days: 7

  # Build and test MVP image
  build-mvp:
    runs-on: ubuntu-latest
    needs: [setup]
    if: needs.setup.outputs.build_mvp == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker

      # Always build base image first for MVP
      - name: Build base image
        run: |
          docker build \
            -t dev8-base:${{ needs.setup.outputs.version }} \
            -t dev8-base:latest \
            -f ./docker/base/Dockerfile \
            .

      - name: Build MVP image
        run: |
          docker build \
            --build-arg BASE_IMAGE=dev8-base:latest \
            --build-arg VERSION=${{ needs.setup.outputs.version }} \
            -t dev8-mvp:${{ needs.setup.outputs.version }} \
            -t dev8-mvp:latest \
            -f ./docker/mvp/Dockerfile \
            .

      - name: Test MVP image
        run: |
          echo "Testing MVP image components..."
          docker run --rm dev8-mvp:latest node --version
          docker run --rm dev8-mvp:latest python --version
          docker run --rm dev8-mvp:latest go version
          docker run --rm dev8-mvp:latest code-server --version || echo "code-server check skipped"
          docker run --rm dev8-mvp:latest aws --version || echo "aws check skipped"
          docker run --rm dev8-mvp:latest test -f /home/dev8/.backup-scripts/backup.sh && echo "Backup script exists" || echo "Backup script missing"
          echo "MVP image tests completed!"

      - name: Scan for vulnerabilities
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: dev8-mvp:${{ needs.setup.outputs.version }}
          format: 'sarif'
          output: 'trivy-mvp-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-mvp-results.sarif') != ''
        with:
          sarif_file: 'trivy-mvp-results.sarif'
          category: docker-mvp

  # Generate build summary
  summary:
    runs-on: ubuntu-latest
    needs: [setup, build-base, build-mvp]
    if: always()
    steps:
      - name: Generate summary
        run: |
          {
            echo "# Docker Images Build Summary"
            echo ""
            echo "## Build Status"
            echo ""
            echo "| Image | Status |"
            echo "|-------|--------|"
            echo "| dev8-base | ${{ needs.build-base.result }} |"
            echo "| dev8-mvp | ${{ needs.build-mvp.result }} |"
            echo ""
            echo "## Version"
            echo "- **Version**: ${{ needs.setup.outputs.version }}"
            echo "- **Commit**: ${{ github.sha }}"
            echo "- **Branch**: ${{ github.ref_name }}"
          } >> "$GITHUB_STEP_SUMMARY"
